name: HomeGenie CI/CD

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'homegenie-app/**'
      - 'README.md'
      - 'Readme.md'
      - '**.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'homegenie-app/**'
      - 'README.md'
      - 'Readme.md'
      - '**.md'

env:
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPO_NAME: homegenie-repo
  IMAGE_BASE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/homegenie-repo

jobs:
  test-user-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: userservice
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Run Tests
        run: |
          chmod +x ./mvnw
          ./mvnw test -B
      - name: Build
        run: ./mvnw package -DskipTests -B

  test-maintenance-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: maintenanceservice
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Run Tests
        run: |
          chmod +x ./mvnw
          ./mvnw test -B
      - name: Build
        run: ./mvnw package -DskipTests -B

  test-notification-service:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: notification-service
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Run Tests
        run: mvn test -B
      - name: Build
        run: mvn package -DskipTests -B

  build-gateway:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api-gateway
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Build
        run: mvn package -DskipTests -B

  build-and-push:
    needs: [test-user-service, test-maintenance-service, test-notification-service, build-gateway]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build & Push user-service
        run: |
          docker build -t ${{ env.IMAGE_BASE }}/user-service:latest -t ${{ env.IMAGE_BASE }}/user-service:${{ github.sha }} ./userservice
          docker push ${{ env.IMAGE_BASE }}/user-service:latest
          docker push ${{ env.IMAGE_BASE }}/user-service:${{ github.sha }}

      - name: Build & Push maintenance-service
        run: |
          docker build -t ${{ env.IMAGE_BASE }}/maintenance-service:latest -t ${{ env.IMAGE_BASE }}/maintenance-service:${{ github.sha }} ./maintenanceservice
          docker push ${{ env.IMAGE_BASE }}/maintenance-service:latest
          docker push ${{ env.IMAGE_BASE }}/maintenance-service:${{ github.sha }}

      - name: Build & Push notification-service
        run: |
          docker build -t ${{ env.IMAGE_BASE }}/notification-service:latest -t ${{ env.IMAGE_BASE }}/notification-service:${{ github.sha }} ./notification-service
          docker push ${{ env.IMAGE_BASE }}/notification-service:latest
          docker push ${{ env.IMAGE_BASE }}/notification-service:${{ github.sha }}

      - name: Build & Push voice-service
        run: |
          docker build -t ${{ env.IMAGE_BASE }}/voice-service:latest -t ${{ env.IMAGE_BASE }}/voice-service:${{ github.sha }} ./python-voice-service
          docker push ${{ env.IMAGE_BASE }}/voice-service:latest
          docker push ${{ env.IMAGE_BASE }}/voice-service:${{ github.sha }}

      - name: Build & Push api-gateway
        run: |
          docker build -t ${{ env.IMAGE_BASE }}/api-gateway:latest -t ${{ env.IMAGE_BASE }}/api-gateway:${{ github.sha }} ./api-gateway
          docker push ${{ env.IMAGE_BASE }}/api-gateway:latest
          docker push ${{ env.IMAGE_BASE }}/api-gateway:${{ github.sha }}

  deploy-backend-services:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy user-service to Cloud Run
        run: |
          gcloud run deploy user-service \
            --image=${{ env.IMAGE_BASE }}/user-service:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars="SPRING_PROFILES_ACTIVE=prod,CLOUD_SQL_ENABLED=true,CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }},CLOUD_SQL_DB=homegenie_users,DB_USERNAME=${{ secrets.DB_USERNAME }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --quiet

      - name: Deploy maintenance-service to Cloud Run
        run: |
          gcloud run deploy maintenance-service \
            --image=${{ env.IMAGE_BASE }}/maintenance-service:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars="SPRING_PROFILES_ACTIVE=prod,CLOUD_SQL_ENABLED=true,CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }},CLOUD_SQL_DB=homegenie_maintenance,DB_USERNAME=${{ secrets.DB_USERNAME }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},GCP_STORAGE_BUCKET=${{ secrets.GCP_STORAGE_BUCKET }}" \
            --quiet

      - name: Deploy notification-service to Cloud Run
        run: |
          gcloud run deploy notification-service \
            --image=${{ env.IMAGE_BASE }}/notification-service:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="SPRING_PROFILES_ACTIVE=prod" \
            --quiet

      - name: Deploy voice-service to Cloud Run
        run: |
          gcloud run deploy voice-service \
            --image=${{ env.IMAGE_BASE }}/voice-service:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
            --quiet

  deploy-api-gateway:
    needs: [deploy-backend-services]
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Service URLs & Deploy API Gateway
        run: |
          USER_URL=$(gcloud run services describe user-service --region=${{ env.GCP_REGION }} --format='value(status.url)')
          MAINT_URL=$(gcloud run services describe maintenance-service --region=${{ env.GCP_REGION }} --format='value(status.url)')
          VOICE_URL=$(gcloud run services describe voice-service --region=${{ env.GCP_REGION }} --format='value(status.url)')
          NOTIF_URL=$(gcloud run services describe notification-service --region=${{ env.GCP_REGION }} --format='value(status.url)')

          echo "User Service:         $USER_URL"
          echo "Maintenance Service:  $MAINT_URL"
          echo "Voice Service:        $VOICE_URL"
          echo "Notification Service: $NOTIF_URL"

          gcloud run deploy api-gateway \
            --image=${{ env.IMAGE_BASE }}/api-gateway:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="USER_SERVICE_URL=${USER_URL},MAINTENANCE_SERVICE_URL=${MAINT_URL},VOICE_SERVICE_URL=${VOICE_URL},NOTIFICATION_SERVICE_URL=${NOTIF_URL},CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }},JWT_SECRET=${{ secrets.JWT_SECRET }},REDIS_HOST=${{ secrets.REDIS_HOST }},REDIS_PORT=${{ secrets.REDIS_PORT }},REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }},REDIS_SSL=true" \
            --quiet

      - name: Print API Gateway URL
        run: |
          GATEWAY_URL=$(gcloud run services describe api-gateway --region=${{ env.GCP_REGION }} --format='value(status.url)')
          echo "============================================"
          echo "üéâ Deployment Complete!"
          echo "üåê API Gateway URL: $GATEWAY_URL"
          echo "============================================"
